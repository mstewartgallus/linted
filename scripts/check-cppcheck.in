#! /usr/bin/env sh
# Copyright (C) 2015 Steven Stewart-Gallus
#
# Copying and distribution of this file, with or without modification,
# are permitted in any medium without royalty provided the copyright
# notice and this notice are preserved.

set -e
set -C
set -u

SCRIPTS="@srcdir@"
BINARY="$1"

: ${LINTED_CPPCHECK:=cppcheck}

source_cflags() {
    "${SCRIPTS}/json-cc-flags.py" "${BINARY}"
}

source_files() {
    "${SCRIPTS}/json-cc-files.py" "${BINARY}"
}

(source_cflags && source_files) | \
xargs --delimiter='\n' -- \
"${LINTED_CPPCHECK}"\
    -D__linux__\
    -D__unix__\
    -D__amd64__\
    -I'/usr/include'\
    -I'/usr/include/x86_64-linux-gnu'\
    -I'/usr/lib/clang/3.6/include'\
    --quiet\
    --enable=warning\
    --enable=style\
    --enable=performance\
    --enable=portability\
    --enable=information\
    --enable=missingInclude\
    --template='{file}:{line}: ({id}) {message}'
