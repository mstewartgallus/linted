#! /usr/bin/env sh
# Copyright (C) 2015 Steven Stewart-Gallus
#
# Copying and distribution of this file, with or without modification,
# are permitted in any medium without royalty provided the copyright
# notice and this notice are preserved.

set -e
set -C
set -u

go() {
    SCRIPTS="@srcdir@/scripts"
    : ${LINTED_IWYU:=iwyu}

    for BINARY in $(make -s list-programs)
    do
        "${SCRIPTS}/json-cc-files.py" "${BINARY}" | {
            while IFS='' read -r II
            do
                "${SCRIPTS}/json-cc-flags.py" "${BINARY}" | xargs --delimiter='\n' -- "${LINTED_IWYU}" "${II}"  & :
            done
            wait
        } & :
    done
    wait
}

go "$@"
