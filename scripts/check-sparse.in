#! /usr/bin/env sh
# Copyright (C) 2015 Steven Stewart-Gallus
#
# Copying and distribution of this file, with or without modification,
# are permitted in any medium without royalty provided the copyright
# notice and this notice are preserved.

set -e
set -C
set -u

go() {
    SCRIPTS="@srcdir@/scripts"
    : ${LINTED_SPARSE:=sparse}

    for BINARY in $(make -s list-programs)
    do
        ("${SCRIPTS}/json-cc-flags.py" "${BINARY}" && "${SCRIPTS}/json-cc-files.py" "${BINARY}") | \
            xargs --delimiter='\n' -- \
            "${LINTED_SPARSE}"\
                -D__linux__\
                -D__unix__\
                -D__amd64__\
                -gcc-base-dir '/usr/lib/gcc/x86_64-linux-gnu/4.8.2'\
                -I/usr/include/x86_64-linux-gnu\
                -Wsparse-all\
                -Wno-declaration-after-statement\
                -Wno-non-pointer-null\
                -Wno-transparent-union\
                -Wno-undef\
                -Wno-cast-truncate\
                -Wno-missing-braces & :
    done
    wait
}

go "$@"
