#! /usr/bin/env sh
# Copyright (C) 2015 Steven Stewart-Gallus
#
# Copying and distribution of this file, with or without modification,
# are permitted in any medium without royalty provided the copyright
# notice and this notice are preserved.

set -e
set -C
set -u

SCRIPTS="@srcdir@"
BINARY="$1"

: ${LINTED_FRAMA_C:=frama-c}

source_cflags() {
    for II in $("${SCRIPTS}/json-cc-flags.py" "${BINARY}"); do
        echo -cpp-extra-args="${II}"
    done
}

frama_c_stdlib() {
    echo -cpp-extra-args="-I$("${LINTED_FRAMA_C}" -print-share-path)/libc"
}

source_files() {
    "${SCRIPTS}/json-cc-files.py" "${BINARY}"
}


"${LINTED_FRAMA_C}"\
    -quiet\
    -journal-disable\
    -pp-annot\
    -machdep x86_64\
    -warn-signed-downcast\
    -warn-unsigned-downcast\
    -warn-unsigned-overflow\
    -warn-decimal-float none\
    -cpp-extra-args='-C'\
    $(source_cflags)\
    $(frama_c_stdlib)\
    $(source_files)
